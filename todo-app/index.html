<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo App</title>
    <style>
      img {
        max-width: 600px;
        width: 100%;
        height: auto;
        border: 1px solid #ddd;
        margin: 1rem 0;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1>The project App</h1>
      <img id="randomImage" src="/cached-image.jpg" alt="random picture" />
      <div>
        <form id="todoForm" action="/api/todos" method="post">
          <input type="text" id="todo" name="todo" required maxlength="140" />
          <button type="submit" id="create-todo">Create todo</button>
        </form>
      </div>
      <div id="todos">
        <ul id="todoList"></ul>
      </div>
      <p>DevOps with Kubernetes 2025</p>
    </div>
    <script>
      const img = document.getElementById("randomImage");
      function refreshImage() {
        img.src = "/cached-image.jpg?ts=" + Date.now();
      }
      refreshImage();
      setInterval(refreshImage, 10 * 60 * 1000);

      const todoListEl = document.getElementById("todoList");
      const form = document.getElementById("todoForm");
      const input = document.getElementById("todo");

      async function loadTodos() {
        todoListEl.innerHTML = "";
        try {
          const resp = await fetch("/api/todos");
          if (!resp.ok) throw new Error("Failed to fetch todos");
          let todos = await resp.json();
          if (typeof todos === "string") {
            try {
              todos = JSON.parse(todos);
            } catch (e) {
              todos = [];
            }
          }
          (Array.isArray(todos) ? todos : []).forEach((t) => {
            const li = document.createElement("li");
            li.textContent =
              typeof t === "string"
                ? t
                : t.name || t.title || JSON.stringify(t);
            todoListEl.appendChild(li);
          });
        } catch (err) {
          console.error("loadTodos error:", err);
          const li = document.createElement("li");
          li.textContent = "Failed to load todos";
          todoListEl.appendChild(li);
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const value = (input.value || "").trim();
        if (!value || value.length > 140) return;
        const optimistic = document.createElement("li");
        optimistic.textContent = value;
        todoListEl.appendChild(optimistic);
        input.value = "";
        input.focus();

        try {
          const resp = await fetch("/api/todos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: value }),
          });
          if (!resp.ok) {
            console.error("Failed to persist todo");
          } else {
            await loadTodos();
          }
        } catch (err) {
          console.error("POST /api/todos failed:", err);
        }
      });

      document.addEventListener("DOMContentLoaded", loadTodos);
    </script>
  </body>
</html>
